<!DOCTYPE html> <!-- `site.alt_lang` can specify a language different from the UI --> <html lang="en" > <!-- The Head --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" > <title>Haskell records | Thomas Bidne </title> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://realfavicongenerator.net/ --> <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/iOS Safari Web Clip/icons8-butterfly-plumpy-57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/iOS Safari Web Clip/icons8-butterfly-plumpy-60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/iOS Safari Web Clip/icons8-butterfly-plumpy-72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/iOS Safari Web Clip/icons8-butterfly-plumpy-76.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/Web/icons8-butterfly-plumpy-96.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/Web/icons8-butterfly-plumpy-32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/Web/icons8-butterfly-plumpy-16.png"> <link rel="manifest" href="/assets/img/favicons/Android Chrome/webmanifest.json"> <meta name="apple-mobile-web-app-title" content="Thomas Bidne"> <meta name="application-name" content="Thomas Bidne"> <meta name="theme-color" content="#ffffff"> <link rel="preconnect" href="https://fonts.googleapis.com" > <link rel="dns-prefetch" href="https://fonts.googleapis.com" > <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin> <link rel="preconnect" href="https://fonts.googleapis.com" > <link rel="dns-prefetch" href="https://fonts.googleapis.com" > <link rel="preconnect" href="https://cdn.jsdelivr.net" > <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" > <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"> <!-- Bootstrap --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"> <!-- Font Awesome --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"> <link rel="stylesheet" href="/assets/css/style.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"> <!-- Manific Popup --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <!-- JavaScript --> <script src=""></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <!-- Switch the mode between dark and light. --> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script> </head> <body data-topbar-visible="true"> <!-- The Side Bar --> <div id="sidebar" class="d-flex flex-column align-items-end"> <div class="profile-wrapper text-center"> <div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a> </div> <div class="site-title"> <a href="/">Thomas Bidne</a> </div> <div class="site-subtitle font-italic"></div> </div><!-- .profile-wrapper --> <ul class="w-100"> <li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a> </li> <li class="nav-item"> <a href="/about/" class="nav-link"> <span>ABOUT</span> </a> </li> <li class="nav-item"> <a href="/archives/" class="nav-link"> <span>ARCHIVES</span> </a> </li> <li class="nav-item"> <a href="/categories/" class="nav-link"> <span>CATEGORIES</span> </a> </li> <li class="nav-item"> <a href="/projects/" class="nav-link"> <span>PROJECTS</span> </a> </li> <li class="nav-item"> <a href="/resume/" class="nav-link"> <span>RESUME</span> </a> </li> </ul> <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tbidne" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/tbidne" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['tbidne','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> </div> <!-- .sidebar-bottom --> </div><!-- #sidebar --> <!-- The Top Bar --> <div id="topbar-wrapper"> <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Haskell records</span> </span><!-- endof #breadcrumb --> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <div id="topbar-title"> Post </div> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span> </div> </div> <div id="main-wrapper" class="d-flex justify-content-center"> <div id="main" class="container pl-xl-4 pr-xl-4"> <div class="row"> <!-- core --> <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"> <div class="post pl-1 pr-1 pl-md-2 pr-md-2"> <!-- Refactor the HTML structure. --> <!-- In order to allow a wide table to scroll horizontally, we suround the markdown table with `<div class="table-wrapper">` and `</div>` --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --> <!-- Change the icon of checkbox --> <!-- images --> <!-- Add header for code snippets --> <!-- Create heading anchors --> <!-- return --> <h1 data-toc-skip>Haskell records</h1> <div class="post-meta text-muted"> <!-- published date --> <span> Posted <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <em class="" data-ts="1709150400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 29, 2024 </em> </span> <!-- lastmod date --> <span> Updated <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <em class="" data-ts="1709242800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 1, 2024 </em> </span> <div class="d-flex justify-content-between"> <!-- author(s) --> <span> By <em> <a href="https://github.com/tbidne">Thomas Bidne</a> </em> </span> <div> <!-- page views --> <!-- read time --> <!-- Calculate the post's reading time, and display the word count in tooltip --> <!-- words per minute --> <!-- return element --> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2591 words"> <em>14 min</em> read</span> </div> </div> <!-- .d-flex --> </div> <!-- .post-meta --> <div class="post-content"> <h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <p>Haskell records appear simple, but this simplicity belies some significant drawbacks. While there are a plethora of libraries and language extensions that improve ergonomics, the trade-offs are not immediately obvious.</p> <p>This post describes two of the most popular approaches, with an eye towards future improvements.</p> <h2 id="records-a-background"><span class="mr-2">Records, a background</span><a href="#records-a-background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <p>By records, we mean product types that have named fields. For example:</p> <div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

  <span class="kd">class</span> <span class="nf">Employee</span><span class="o">(</span><span class="nc">String</span> <span class="n">n</span><span class="o">,</span> <span class="nc">String</span> <span class="n">t</span><span class="o">,</span> <span class="nc">Int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="nc">String</span> <span class="nf">greetEmployee</span><span class="o">(</span><span class="nc">Employee</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Hello "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>We have a type representing an employee that includes fields for a name, title, and age. Not only do we have the fields themselves, we associate a <em>name</em> with them. To see why this matters, consider the following haskell code:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span> <span class="kt">String</span> <span class="kt">String</span> <span class="kt">Int</span>

<span class="n">mkEmployee</span> <span class="o">::</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Employee</span>
<span class="n">mkEmployee</span> <span class="n">name</span> <span class="n">title</span> <span class="n">age</span> <span class="o">=</span> <span class="kt">MkEmployee</span> <span class="n">name</span> <span class="n">title</span> <span class="n">age</span>

<span class="n">greetEmployee</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">greetEmployee</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="n">n</span> <span class="kr">_</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="s">"Hello "</span> <span class="o">++</span> <span class="n">n</span> <span class="o">++</span> <span class="s">"!"</span>
</pre></td></tr></tbody></table></code></div></div> <p>Like the java example, this declares an <code class="language-plaintext highlighter-rouge">Employee</code> type that takes two strings and an int. Unlike the java example, however, the fields are unnamed. To access them we have to use pattern-matching. The downside is that we have to remember which field is which. This is especially problematic when we have multiple fields with the same type. For instance, the following code typechecks, yet is clearly a mistake, as we use the field intended for the <code class="language-plaintext highlighter-rouge">title</code>, not the <code class="language-plaintext highlighter-rouge">name</code>:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">greetEmployee</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">greetEmployee</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="kr">_</span> <span class="n">t</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="s">"Hello "</span> <span class="o">++</span> <span class="n">t</span> <span class="o">++</span> <span class="s">"!"</span>
</pre></td></tr></tbody></table></code></div></div> <p>Not only is it easy to make mistakes, it also means we need to modify <code class="language-plaintext highlighter-rouge">greetEmployee</code> any time we add or remove a field from <code class="language-plaintext highlighter-rouge">Employee</code>.</p> <p>Fortunately, haskell provides “record syntax” that allows us to name fields:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">age</span> <span class="o">::</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="n">mkEmployee</span> <span class="o">::</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Employee</span>
<span class="n">mkEmployee</span> <span class="n">n</span> <span class="n">t</span> <span class="n">a</span> <span class="o">=</span>
  <span class="kt">MkEmployee</span>
    <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
      <span class="n">title</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span>
      <span class="n">age</span> <span class="o">=</span> <span class="n">a</span>
    <span class="p">}</span>

<span class="n">greetEmployee</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">greetEmployee</span> <span class="n">e</span> <span class="o">=</span> <span class="s">"Hello "</span> <span class="o">++</span> <span class="n">name</span> <span class="n">e</span> <span class="o">++</span> <span class="s">"!"</span>
</pre></td></tr></tbody></table></code></div></div> <p>Much better! Pattern matching still works, but we can now use the names to write clearer code that is less vulnerable to updates. All is well, right?</p> <h2 id="all-is-not-well"><span class="mr-2">All is not well</span><a href="#all-is-not-well" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <h3 id="problem-1-duplicate-field-names"><span class="mr-2">Problem 1: Duplicate Field Names</span><a href="#problem-1-duplicate-field-names" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>Suppose we want to create two types with the same field name:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">age</span> <span class="o">::</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="kr">data</span> <span class="kt">Company</span> <span class="o">=</span> <span class="kt">MkCompany</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">employee</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="c1">-- it's a small company, okay?</span>
  <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>Unfortunately, these will not compile in the same module! The problem is that haskell’s record syntax essentially generates “field selectors” for each field i.e. for <code class="language-plaintext highlighter-rouge">Employee</code>:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">name</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">name</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="n">n</span> <span class="kr">_</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>

<span class="n">title</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">title</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="kr">_</span> <span class="n">t</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>

<span class="n">age</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">age</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="kr">_</span> <span class="kr">_</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span>
</pre></td></tr></tbody></table></code></div></div> <p>So if we try to compile <code class="language-plaintext highlighter-rouge">Employee</code> and <code class="language-plaintext highlighter-rouge">Company</code> we’d have:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">name</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">name</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="n">n</span> <span class="kr">_</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>

<span class="n">name</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">name</span> <span class="p">(</span><span class="kt">MkCompany</span> <span class="n">n</span> <span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
</pre></td></tr></tbody></table></code></div></div> <p>But we cannot have two top-level functions with the same name, hence the error.<sup id="fnref:fn1" role="doc-noteref"><a href="#fn:fn1" class="footnote" rel="footnote">1</a></sup> The work-around is to declare these data types in different modules, and then qualify their usage:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">-- Employee.hs</span>
<span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">-- Company.hs</span>
<span class="kr">data</span> <span class="kt">Company</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">-- Lib.hs</span>
<span class="kr">module</span> <span class="nn">Lib</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Company</span> <span class="p">(</span><span class="kt">Company</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Company</span> <span class="n">qualified</span> <span class="n">as</span> <span class="kt">Company</span>
<span class="kr">import</span> <span class="nn">Employee</span> <span class="p">(</span><span class="kt">Employee</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Employee</span> <span class="n">qualified</span> <span class="n">as</span> <span class="kt">Employee</span>

<span class="n">msg</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">msg</span> <span class="n">c</span> <span class="o">=</span> <span class="kt">Employee</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="kt">Company</span><span class="o">.</span><span class="n">employee</span> <span class="n">c</span><span class="p">)</span> <span class="o">++</span> <span class="s">" works at "</span> <span class="o">++</span> <span class="kt">Company</span><span class="o">.</span><span class="n">name</span> <span class="n">c</span>
</pre></td></tr></tbody></table></code></div></div> <p>This works, but isn’t terribly satisfying.</p> <h3 id="problem-2-nested-updates"><span class="mr-2">Problem 2: Nested Updates</span><a href="#problem-2-nested-updates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>Haskell’s record syntax offers a further convenience; we can model updates:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">setName</span> <span class="o">::</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Employee</span>
<span class="n">setName</span> <span class="n">e</span> <span class="n">newName</span> <span class="o">=</span> <span class="n">e</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="n">newName</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>The <code class="language-plaintext highlighter-rouge">setName</code> function takes an employee <code class="language-plaintext highlighter-rouge">e</code>, new name <code class="language-plaintext highlighter-rouge">newName</code>, and returns a new employee <code class="language-plaintext highlighter-rouge">e'</code> that is the same as <code class="language-plaintext highlighter-rouge">e</code> except its name is <code class="language-plaintext highlighter-rouge">newName</code>. This is useful as it means we do not have to manually copy over unchanged fields when we want to change just one.</p> <p>There is a limitation, however: nested updates do not compose. That is, there is nothing like the following pseudo-syntax:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">setEmployeeName</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Company</span>
<span class="n">setEmployeeName</span> <span class="n">c</span> <span class="n">newEmpName</span> <span class="o">=</span> <span class="n">c</span> <span class="p">{</span> <span class="n">employee</span> <span class="o">=</span> <span class="n">employee</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="n">newEmpName</span> <span class="p">}</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>In other words, while update syntax allows us to update e.g. <code class="language-plaintext highlighter-rouge">company.employee</code> and <code class="language-plaintext highlighter-rouge">employee.name</code>, it does not work to update <code class="language-plaintext highlighter-rouge">company.employee.name</code>. This is unfortunate, as it greatly increases the difficulty of working with immutable data.<sup id="fnref:fn2" role="doc-noteref"><a href="#fn:fn2" class="footnote" rel="footnote">2</a></sup></p> <h2 id="solution-1-overloadedrecorddot"><span class="mr-2">Solution 1: OverloadedRecordDot</span><a href="#solution-1-overloadedrecorddot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <p>This is the simplest solution that will be the most familiar to users with experience in mainstream languages.</p> <p>GHC 9.2 introduced the <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code> extension. With it, we can rewrite our modules as follows:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cp">{-# LANGUAGE DuplicateRecordFields #-}</span> <span class="c1">-- we need this too</span>
<span class="cp">{-# LANGUAGE OverloadedRecordDot #-}</span>

<span class="kr">module</span> <span class="nn">Data</span> <span class="kr">where</span>

<span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">age</span> <span class="o">::</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="kr">data</span> <span class="kt">Company</span> <span class="o">=</span> <span class="kt">MkCompany</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">employee</span> <span class="o">::</span> <span class="kt">Employee</span>
  <span class="p">}</span>

<span class="n">msg</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">msg</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">employee</span><span class="o">.</span><span class="n">name</span> <span class="o">++</span> <span class="s">" works at "</span> <span class="o">++</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span>
</pre></td></tr></tbody></table></code></div></div> <p>Much nicer! Not only is this more concise and familiar, it allows both definition and usage of duplicate record fields, completely solving problem 1.</p> <!-- prettier-ignore-start --> <blockquote class="prompt-tip"> <p>Note that the record field needs to be in scope in order to use it. For example:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kr">module</span> <span class="nn">Foo</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Data</span> <span class="p">(</span><span class="kt">Company</span> <span class="p">(</span><span class="nf">name</span><span class="p">))</span> <span class="c1">-- need to import name here</span>

<span class="n">getCompanyGreeting</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">getCompanyGreeting</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">++</span> <span class="s">" welcomes you"</span>

</pre></td></tr></tbody></table></code></div> </div> </blockquote> <!-- prettier-ignore-end --> <h3 id="dont-get-too-excited-just-yet"><span class="mr-2">Don’t get too excited just yet</span><a href="#dont-get-too-excited-just-yet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>While this neatly solves the problem of duplicate names, this does not help with nested updates. In fact, <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code> does not work for updates at all. For that, we need another extension, <code class="language-plaintext highlighter-rouge">-XOverloadedRecordUpdate</code>, plus some boilerplate. Brace yourself:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="cp">{-# LANGUAGE AllowAmbiguousTypes #-}</span>
<span class="cp">{-# LANGUAGE DataKinds #-}</span>
<span class="cp">{-# LANGUAGE DuplicateRecordFields #-}</span>
<span class="cp">{-# LANGUAGE FlexibleInstances #-}</span>
<span class="cp">{-# LANGUAGE FunctionalDependencies #-}</span>
<span class="cp">{-# LANGUAGE OverloadedRecordDot #-}</span>
<span class="cp">{-# LANGUAGE OverloadedRecordUpdate #-}</span>
<span class="cp">{-# LANGUAGE PolyKinds #-}</span>
<span class="cp">{-# LANGUAGE RebindableSyntax #-}</span>
<span class="cp">{-# LANGUAGE ScopedTypeVariables #-}</span>
<span class="cp">{-# LANGUAGE TypeApplications #-}</span>
<span class="cp">{-# LANGUAGE TypeSynonymInstances #-}</span>

<span class="kr">module</span> <span class="nn">Data</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Prelude</span>

<span class="c1">-- Because of RebindableSyntax, we need to declare the HasField class,</span>
<span class="c1">-- getField, and setField ourselves.</span>

<span class="kr">class</span> <span class="kt">HasField</span> <span class="n">x</span> <span class="n">r</span> <span class="n">a</span> <span class="o">|</span> <span class="n">x</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="n">hasField</span> <span class="o">::</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="n">getField</span> <span class="o">::</span> <span class="n">forall</span> <span class="n">x</span> <span class="n">r</span> <span class="n">a</span> <span class="o">.</span> <span class="kt">HasField</span> <span class="n">x</span> <span class="n">r</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">a</span>
<span class="n">getField</span> <span class="o">=</span> <span class="n">snd</span> <span class="o">.</span> <span class="n">hasField</span> <span class="o">@</span><span class="n">x</span>

<span class="n">setField</span> <span class="o">::</span> <span class="n">forall</span> <span class="n">x</span> <span class="n">r</span> <span class="n">a</span> <span class="o">.</span> <span class="kt">HasField</span> <span class="n">x</span> <span class="n">r</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">r</span>
<span class="n">setField</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">.</span> <span class="n">hasField</span> <span class="o">@</span><span class="n">x</span>

<span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">age</span> <span class="o">::</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="c1">-- manually write instances for each field that we want</span>

<span class="kr">instance</span> <span class="kt">HasField</span> <span class="s">"name"</span> <span class="kt">Employee</span> <span class="kt">String</span> <span class="kr">where</span>
  <span class="n">hasField</span> <span class="n">e</span><span class="o">@</span><span class="p">(</span><span class="kt">MkEmployee</span> <span class="n">name</span> <span class="n">title</span> <span class="n">age</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nf">\</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="kt">MkEmployee</span> <span class="n">n</span> <span class="n">title</span> <span class="n">age</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Company</span> <span class="o">=</span> <span class="kt">MkCompany</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">employee</span> <span class="o">::</span> <span class="kt">Employee</span>
  <span class="p">}</span>

<span class="kr">instance</span> <span class="kt">HasField</span> <span class="s">"employee"</span> <span class="kt">Company</span> <span class="kt">Employee</span> <span class="kr">where</span>
  <span class="n">hasField</span> <span class="n">c</span><span class="o">@</span><span class="p">(</span><span class="kt">MkCompany</span> <span class="n">name</span> <span class="n">employee</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="kt">MkCompany</span> <span class="n">name</span> <span class="n">e</span><span class="p">,</span> <span class="n">employee</span><span class="p">)</span>

<span class="c1">-- now we can use it</span>

<span class="n">setEmployeeName</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Company</span>
<span class="n">setEmployeeName</span> <span class="n">c</span> <span class="n">newEmpName</span> <span class="o">=</span> <span class="n">c</span> <span class="p">{</span> <span class="n">employee</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newEmpName</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>Yikes! As you can see, this is a far-cry from the simplicity of <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code>. The unfortunate truth is that as of GHC 9.8, <code class="language-plaintext highlighter-rouge">-XOverloadedRecordUpdate</code> is a bit of a hack. It relies on several other extensions – including the huge hammer <code class="language-plaintext highlighter-rouge">-XRebindableSyntax</code> – which can break all sorts of normal code.</p> <p>Even the <a href="https://downloads.haskell.org/ghc/9.8.2/docs/users_guide/exts/overloaded_record_update.html">docs</a> explicitly warn against using it.</p> <p>There is good news, however. A proposal to improve the situation was accepted in <a href="https://github.com/ghc-proposals/ghc-proposals/pull/583">October 2023</a>, and updates should work after this is implemented. This will not cover <em>all</em> use cases: type-changing updates will not immediately be supported. But this will easily cover typical record usage.</p> <h2 id="solution-2-optics"><span class="mr-2">Solution 2: Optics</span><a href="#solution-2-optics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <p>Optics provide a second solution. Unlike <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code>, optics are not built-in; they are implemented at the library level. Not only do we therefore have to choose an optics library (there are many), there are often more choices to make. Here we choose <a href="https://hackage.haskell.org/package/optics-core"><code class="language-plaintext highlighter-rouge">optics-core</code></a> (and <a href="https://hackage.haskell.org/package/optics-th"><code class="language-plaintext highlighter-rouge">optics-th</code></a> for generating optics automatically) with <code class="language-plaintext highlighter-rouge">-XOverloadedLabels</code> style:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="cp">{-# LANGUAGE DataKinds #-}</span>
<span class="cp">{-# LANGUAGE DuplicateRecordFields #-}</span>
<span class="cp">{-# LANGUAGE FlexibleInstances #-}</span>
<span class="cp">{-# LANGUAGE MultiParamTypeClasses #-}</span>
<span class="cp">{-# LANGUAGE OverloadedLabels #-}</span>
<span class="cp">{-# LANGUAGE TemplateHaskell #-}</span>
<span class="cp">{-# LANGUAGE TypeFamilies #-}</span>
<span class="cp">{-# LANGUAGE UndecidableInstances #-}</span>

<span class="kr">module</span> <span class="nn">Data</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Optics.Core</span> <span class="p">(</span><span class="nf">set</span><span class="p">,</span> <span class="nf">view</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Optics.TH</span> <span class="p">(</span><span class="nf">makeFieldLabelsNoPrefix</span><span class="p">)</span> <span class="c1">-- optics-th library</span>

<span class="kr">data</span> <span class="kt">Employee</span> <span class="o">=</span> <span class="kt">MkEmployee</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">age</span> <span class="o">::</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="n">makeFieldLabelsNoPrefix</span> <span class="n">''Employee</span>

<span class="kr">data</span> <span class="kt">Company</span> <span class="o">=</span> <span class="kt">MkCompany</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span><span class="p">,</span>
    <span class="n">employee</span> <span class="o">::</span> <span class="kt">Employee</span>
  <span class="p">}</span>

<span class="n">makeFieldLabelsNoPrefix</span> <span class="n">''Company</span>

<span class="n">msg</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">msg</span> <span class="n">c</span> <span class="o">=</span> <span class="n">view</span> <span class="p">(</span><span class="o">#</span><span class="n">employee</span> <span class="o">%</span> <span class="o">#</span><span class="n">name</span><span class="p">)</span> <span class="n">c</span> <span class="o">++</span> <span class="s">" works at "</span> <span class="o">++</span> <span class="n">view</span> <span class="o">#</span><span class="n">name</span> <span class="n">c</span>

<span class="n">setEmployeeName</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Company</span>
<span class="n">setEmployeeName</span> <span class="n">c</span> <span class="n">newEmpName</span> <span class="o">=</span> <span class="n">set</span> <span class="p">(</span><span class="o">#</span><span class="n">employee</span> <span class="o">%</span> <span class="o">#</span><span class="n">name</span><span class="p">)</span> <span class="n">newEmpName</span> <span class="n">c</span>
</pre></td></tr></tbody></table></code></div></div> <p>First, we use <code class="language-plaintext highlighter-rouge">makeFieldLabelsNoPrefix</code> from the <code class="language-plaintext highlighter-rouge">optics-th</code> library to generate lenses (a type of optic). After this, we can implement our getter and setter functions simply using the <code class="language-plaintext highlighter-rouge">#&lt;field-name&gt;</code> syntax. To compose two lenses together, we use the <code class="language-plaintext highlighter-rouge">(%)</code> operator from <code class="language-plaintext highlighter-rouge">optics-core</code>. For instance, the equivalent of <code class="language-plaintext highlighter-rouge">myCompany.employee.name</code> is <code class="language-plaintext highlighter-rouge">view (#employee % #name) myCompany</code>.</p> <h3 id="tell-me-the-catch"><span class="mr-2">Tell me the catch</span><a href="#tell-me-the-catch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>TemplateHaskell (used in <code class="language-plaintext highlighter-rouge">makeFieldLabelsNoPrefix</code>) has several drawbacks. One of the major annoyances is how it requires the source code to be in a specific order. That is, normally you can reorder code in a Haskell module to your heart’s content:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">a</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span>

<span class="n">f</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">f</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">-- It makes no difference whether 'f' or 'a' comes first in a haskell source file.</span>

<span class="n">f</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">f</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">a</span> <span class="o">::</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">a</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span>
</pre></td></tr></tbody></table></code></div></div> <p>With TH this is no longer true. In particular, if you want to use the result of TH, the code that uses it must come <em>after</em> the TH code.</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">-- This works because the usage (msg) comes _after_ the TH definition</span>
<span class="c1">-- (makeFieldLabelsNoPrefix)</span>
<span class="n">makeFieldLabelsNoPrefix</span> <span class="n">''Company</span>

<span class="n">msg</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">msg</span> <span class="n">c</span> <span class="o">=</span> <span class="n">view</span> <span class="p">(</span><span class="o">#</span><span class="n">employee</span> <span class="o">%</span> <span class="o">#</span><span class="n">name</span><span class="p">)</span> <span class="n">c</span> <span class="o">++</span> <span class="s">" works at "</span> <span class="o">++</span> <span class="n">view</span> <span class="o">#</span><span class="n">name</span> <span class="n">c</span>

<span class="c1">-- The below will trigger a "No instance for LabelOptic..." error</span>

<span class="n">msg</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">msg</span> <span class="n">c</span> <span class="o">=</span> <span class="n">view</span> <span class="p">(</span><span class="o">#</span><span class="n">employee</span> <span class="o">%</span> <span class="o">#</span><span class="n">name</span><span class="p">)</span> <span class="n">c</span> <span class="o">++</span> <span class="s">" works at "</span> <span class="o">++</span> <span class="n">view</span> <span class="o">#</span><span class="n">name</span> <span class="n">c</span>

<span class="n">makeFieldLabelsNoPrefix</span> <span class="n">''Company</span>
</pre></td></tr></tbody></table></code></div></div> <p>This can lead to cryptic “No instance for LabelOptic…” errors when there are multiple TH definitions and usages in the same module (“What do you mean no instance? <em>It’s right there</em>.”).</p> <p>TH also comes with other drawbacks:</p> <ul> <li>Increases compilation time.</li> <li>Prevents cross-compilation.</li> </ul> <p>Thus we can drop the dependency on <code class="language-plaintext highlighter-rouge">optics-th</code> and hand-write our lenses instead:</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kr">import</span> <span class="nn">Optics.Core</span> <span class="p">(</span><span class="kt">A_Lens</span><span class="p">,</span> <span class="nf">lensVL</span><span class="p">,</span> <span class="nf">set</span><span class="p">,</span> <span class="nf">view</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Optics.Label</span> <span class="p">(</span><span class="kt">LabelOptic</span><span class="p">(</span><span class="nf">labelOptic</span><span class="p">))</span>

<span class="c1">-- makeFieldLabelsNoPrefix generates the below instances for each field.</span>
<span class="c1">--</span>
<span class="c1">-- The reason for the convoluted equality constraints (e.g. k ~ A_Lens, ...)</span>
<span class="c1">-- over writing them directly (instance LabelOptic "name" A_Lens ...) is</span>
<span class="c1">-- improved type inference.</span>
<span class="c1">--</span>
<span class="c1">-- The INLINEs are for performance.</span>

<span class="c1">-- name lens for employee</span>
<span class="kr">instance</span>
  <span class="p">(</span><span class="n">k</span> <span class="o">~</span> <span class="kt">A_Lens</span><span class="p">,</span> <span class="n">a</span> <span class="o">~</span> <span class="kt">String</span><span class="p">,</span> <span class="n">b</span> <span class="o">~</span> <span class="kt">String</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="kt">LabelOptic</span> <span class="s">"name"</span> <span class="n">k</span> <span class="kt">Employee</span> <span class="kt">Employee</span> <span class="n">a</span> <span class="n">b</span>
  <span class="kr">where</span>
  <span class="n">labelOptic</span> <span class="o">=</span> <span class="n">lensVL</span> <span class="n">nameLens</span>
    <span class="kr">where</span>
      <span class="n">nameLens</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">Employee</span>
      <span class="n">nameLens</span> <span class="n">f</span> <span class="p">(</span><span class="kt">MkEmployee</span> <span class="n">_name</span> <span class="n">_title</span> <span class="n">_age</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="n">name'</span> <span class="o">-&gt;</span> <span class="kt">MkEmployee</span> <span class="n">name'</span> <span class="n">_title</span> <span class="n">_age</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">_name</span><span class="p">)</span>
  <span class="cp">{-# INLINE labelOptic #-}</span>

<span class="c1">-- name lens for company</span>
<span class="kr">instance</span>
  <span class="p">(</span><span class="n">k</span> <span class="o">~</span> <span class="kt">A_Lens</span><span class="p">,</span> <span class="n">a</span> <span class="o">~</span> <span class="kt">String</span><span class="p">,</span> <span class="n">b</span> <span class="o">~</span> <span class="kt">String</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="kt">LabelOptic</span> <span class="s">"name"</span> <span class="n">k</span> <span class="kt">Company</span> <span class="kt">Company</span> <span class="n">a</span> <span class="n">b</span>
  <span class="kr">where</span>
  <span class="n">labelOptic</span> <span class="o">=</span> <span class="n">lensVL</span> <span class="n">nameLens</span>
    <span class="kr">where</span>
      <span class="n">nameLens</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">Company</span>
      <span class="n">nameLens</span> <span class="n">f</span> <span class="p">(</span><span class="kt">MkCompany</span> <span class="n">_name</span> <span class="n">_employee</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="n">name'</span> <span class="o">-&gt;</span> <span class="kt">MkCompany</span> <span class="n">name'</span> <span class="n">_employee</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">_name</span><span class="p">)</span>
  <span class="cp">{-# INLINE labelOptic #-}</span>

<span class="c1">-- employee lens for company</span>
<span class="kr">instance</span>
  <span class="p">(</span><span class="n">k</span> <span class="o">~</span> <span class="kt">A_Lens</span><span class="p">,</span> <span class="n">a</span> <span class="o">~</span> <span class="kt">Employee</span><span class="p">,</span> <span class="n">b</span> <span class="o">~</span> <span class="kt">Employee</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="kt">LabelOptic</span> <span class="s">"employee"</span> <span class="n">k</span> <span class="kt">Company</span> <span class="kt">Company</span> <span class="n">a</span> <span class="n">b</span>
  <span class="kr">where</span>
  <span class="n">labelOptic</span> <span class="o">=</span> <span class="n">lensVL</span> <span class="n">employeeLens</span>
    <span class="kr">where</span>
      <span class="n">employeeLens</span> <span class="o">::</span> <span class="kt">Functor</span> <span class="n">f</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="kt">Employee</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">Employee</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">Company</span>
      <span class="n">employeeLens</span> <span class="n">f</span> <span class="p">(</span><span class="kt">MkCompany</span> <span class="n">_name</span> <span class="n">_employee</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="n">employee'</span> <span class="o">-&gt;</span> <span class="kt">MkCompany</span> <span class="n">_name</span> <span class="n">employee'</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">_employee</span><span class="p">)</span>
  <span class="cp">{-# INLINE labelOptic #-}</span>
</pre></td></tr></tbody></table></code></div></div> <p>That’s it! A bit heavy on the boilerplate, but this solves both duplicate fields <strong>and</strong> nested updates without any TH drawbacks. Additionally, we receive nice features beyond normal getters and setters like <em>modify</em>.</p> <div class="language-haskell highlighter-rouge"><div class="code-header"> <span data-label-text="Haskell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kr">import</span> <span class="nn">Optics.Core</span> <span class="p">(</span><span class="nf">over</span><span class="p">)</span>

<span class="c1">-- using 'over' to _modify_ a nested field rather than simply setting or</span>
<span class="c1">-- getting it.</span>
<span class="n">incEmployeeAge</span> <span class="o">::</span> <span class="kt">Company</span> <span class="o">-&gt;</span> <span class="kt">Company</span>
<span class="n">incEmployeeAge</span> <span class="n">c</span> <span class="o">=</span> <span class="n">over</span> <span class="p">(</span><span class="o">#</span><span class="n">employee</span> <span class="o">%</span> <span class="o">#</span><span class="n">age</span><span class="p">)</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="n">c</span>
</pre></td></tr></tbody></table></code></div></div> <p>In general, optics offer a powerful way to view and modify data, far surpassing what mere getters and setters can do.<sup id="fnref:fn3" role="doc-noteref"><a href="#fn:fn3" class="footnote" rel="footnote">3</a></sup></p> <h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2> <p>Haskell offers a useful record syntax for manipulating data, but this syntax comes with some shortcomings. We have shown two different ways to overcome this: The <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code> extension and the <code class="language-plaintext highlighter-rouge">optics-core</code> library. Which should you use?</p> <p>It depends.</p> <p><code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code> is undoubtedly simpler and friendlier to people coming from other languages. If the primary problem you face is duplicate record fields and you don’t need nested updates all that often, perhaps <code class="language-plaintext highlighter-rouge">-XOverloadedRecordDot</code> is the best choice (and nested updates are hopefully not too far away).</p> <p>If, on the other hand, you want the most complete, sophisticated way of handling data today, take the plunge, and explore how deep the optics rabbit-hole goes.</p> <hr /> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:fn1" role="doc-endnote"> <p>There is an extension <code class="language-plaintext highlighter-rouge">-XDuplicateRecordFields</code> that overcomes this limitation. This only allows the <em>definition</em> – not actual <strong>usage</strong> – so it is not a complete solution. <a href="#fnref:fn1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:fn2" role="doc-endnote"> <p>I wrote about this problem as a motivator for optics <a href="https://tbidne.github.io/posts/optics/">here</a>. <a href="#fnref:fn2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:fn3" role="doc-endnote"> <p>Not only can optics handle fields via lenses, but we can also manipulate sum types via <em>prisms</em>. A full description is beyond the scope of this article, however. <a href="#fnref:fn3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> <div class="post-tail-wrapper text-muted"> <!-- categories --> <div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a> </div> <!-- tags --> <div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/functional-programming/" class="post-tag no-text-decoration" >functional programming</a> <a href="/tags/haskell/" class="post-tag no-text-decoration" >haskell</a> <a href="/tags/programming/" class="post-tag no-text-decoration" >programming</a> </div> <div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"> <div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author. </div> <!-- Post sharing snippet --> <div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Haskell%20records%20-%20Thomas%20Bidne&url=%2Fposts%2Fhaskell-records%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Haskell%20records%20-%20Thomas%20Bidne&u=%2Fposts%2Fhaskell-records%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fhaskell-records%2F&text=Haskell%20records%20-%20Thomas%20Bidne" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2Fhaskell-records%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span> </div> </div><!-- .post-tail-bottom --> </div><!-- div.post-tail-wrapper --> </div> </div> <!-- #core-wrapper --> <!-- panel --> <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"> <div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <div class="panel-heading pl-3 pt-2 mb-2">Contents</div> <nav id="toc"></nav> </div> <!-- toc.js will be loaded at medium priority --> <script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script> </div> </div> <!-- tail --> <div class="row"> <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. --> <!-- The total size of related posts --> <!-- An random integer that bigger than 0 --> <!-- Equals to TAG_SCORE / {max_categories_hierarchy} --> <!-- Fill with the other newlest posts --> <div id="related-posts" class="mb-2 mb-sm-4"> <h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3> <div class="card-deck mb-4"> <div class="card"> <a href="/posts/optics/"> <div class="card-body"> <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <em class="small" data-ts="1681430400" data-df="ll" > Apr 14, 2023 </em> <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Whence cometh optics?</h3> <div class="text-muted small"> <p> Introduction Optics are a powerful tool in certain niche areas of programming, but they can be confusing and intimidating, especially for those coming from a more traditional programming backgroun... </p> </div> </div> </a> </div> <div class="card"> <a href="/posts/monads-monoids/"> <div class="card-body"> <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <em class="small" data-ts="1593388800" data-df="ll" > Jun 29, 2020 </em> <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Monads are just monoids in the category of endofunctors, what's the problem?</h3> <div class="text-muted small"> <p> Introduction The title is from James Iry’s classic A Brief, Incomplete, and Mostly Wrong History of Programming Languages, an hilarious rundown of various programming languages. The statement was ... </p> </div> </div> </a> </div> </div> <!-- .card-deck --> </div> <!-- #related-posts --> <!-- Navigation buttons at the bottom of the post. --> <div class="post-navigation d-flex justify-content-between"> <a href="/posts/optics/" class="btn btn-outline-primary" prompt="Older"> <p>Whence cometh optics?</p> </a> <div class="btn btn-outline-primary disabled" prompt="Newer"> <p>-</p> </div> </div> </div> </div> </div> <!-- The Search results --> <div id="search-result-wrapper" class="d-flex justify-content-center unloaded"> <div class="col-12 col-sm-11 post-content"> <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div> </div> </div> </div> <!-- #main-wrapper --> <!-- The Footer --> <footer> <div class="container pl-lg-4 pr-lg-4"> <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"> <div class="footer-left"> <p class="mb-0"> © 2024 <a href="https://github.com/tbidne">Thomas Bidne</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span> </p> </div> <div class="footer-right"> <p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>. </p> <a target="_blank" href="https://icons8.com/icon/jt6jc0TVClpt/butterfly">Butterfly</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a> </div> </div> </div> </footer> <div id="mask"></div> <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader See: <https://github.com/christian-fei/Simple-Jekyll-Search> --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a> <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags} </div> <p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <!-- JS selector for site. --> <!-- layout specified --> <!-- image lazy-loading & popup & clipboard --> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <!-- commons --> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> </body> </html>
